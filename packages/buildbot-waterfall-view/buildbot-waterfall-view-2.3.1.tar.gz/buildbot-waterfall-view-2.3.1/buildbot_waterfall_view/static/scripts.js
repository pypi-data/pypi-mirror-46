!function(){var t=(0,eval)("this");void 0===t.BOWERDEPS&&(t.BOWERDEPS={})}();class WaterfallView{constructor(){return["ui.router","ngAnimate","guanlecoja.ui","bbData"]}}var WaterfallController=function(){var t=void 0;return Cls=class{static initClass(){t=null,this.prototype.ticks=[]}constructor(e,a,r,i,s,l,n,o,c,d,h,u,m){this.zoomPlus=this.zoomPlus.bind(this),this.zoomMinus=this.zoomMinus.bind(this),this.renderNewData=this.renderNewData.bind(this),this.$rootElement=e,this.$scope=a,this.$window=s,this.$log=l,this.$uibModal=n,this.dataProcessorService=d,this.bbSettingsService=u,t=this;var g=[{caption:"",icon:"search-plus",action:this.zoomPlus},{caption:"",icon:"search-minus",action:this.zoomMinus}],p=this.$rootElement.find("body");p.addClass("hundredpercent"),this.$scope.$on("$destroy",()=>p.removeClass("hundredpercent")),m.setContextualActions(g),this.loading=!0,this.dataAccessor=o.open().closeOnDestroy(this.$scope),this.s=this.bbSettingsService.getSettingsGroup("Waterfall"),this.c={margin:{top:15,right:20,bottom:20,left:70},gap:30,scaling:this.s.scaling_waterfall.value,minColumnWidth:this.s.min_column_width_waterfall.value,timeFormat:"%x^%H:%M",limit:this.s.lazy_limit_waterfall.value,threshold:this.s.idle_threshold_waterfall.value,buildidBackground:this.s.number_background_waterfall.value},this.all_builders=this.dataAccessor.getBuilders({order:"name"}),this.$scope.builders=this.builders=[],this.buildLimit=this.c.limit,this.$scope.builds=this.builds=this.dataAccessor.getBuilds({limit:this.buildLimit,order:"-started_at"}),c.get().then(t=>{this.d3=t,this.scale=new h(this.d3),this.groups=this.dataProcessorService.getGroups(this.all_builders,this.builds,this.c.threshold),this.$scope.builders=this.builders=this.dataProcessorService.filterBuilders(this.all_builders),this.dataProcessorService.addStatus(this.builders),this.waterfall=this.d3.select(".waterfall"),this.container=this.waterfall.select(".svg-container"),this.header=this.waterfall.select(".header-content"),this.createElements(),this.render(),this.loading=!1,this.$scope.$watch(()=>this.waterfall.style("width"),(t,e)=>{if(t!==e)return this.render()},!0),this.loadingMore=!1,this.builds.onChange=this.all_builders.onChange=this.renderNewData;var e=this.container.node().parentNode;angular.element(e).bind("scroll",()=>{if(!this.loadingMore&&this.getHeight()-e.scrollTop<1e3)return this.loadingMore=!0,this.loadMore()});var a=()=>this.render(),r=angular.element(this.$window);r.bind("resize",a);var i=t=>{if("+"===t.key&&(t.preventDefault(),this.zoomPlus()),"-"===t.key)return t.preventDefault(),this.zoomMinus()};return r.bind("keypress",i),this.$scope.$on("$destroy",function(){return r.unbind("keypress",i),r.unbind("resize",a)})})}zoomPlus(){return this.incrementScaleFactor(),this.render()}zoomMinus(){return this.decrementScaleFactor(),this.render()}incrementScaleFactor(){return this.c.scaling*=1.5,this.s.scaling_waterfall.value*=1.5,this.bbSettingsService.save()}decrementScaleFactor(){return this.c.scaling/=1.5,this.s.scaling_waterfall.value/=1.5,this.bbSettingsService.save()}loadMore(){if(!(this.builds.length<this.buildLimit))return this.buildLimit=this.builds.length+this.c.limit,this.dataAccessor.getBuilds({limit:this.buildLimit,order:"-started_at"}).onChange=(t=>(this.builds.close(),this.builds=t,t.onChange=this.renderNewData,t.onChange()))}createElements(){this.container.selectAll("*").remove(),this.header.selectAll("*").remove(),this.chart=this.container.append("svg").append("g").attr("transform","translate(".concat(this.c.margin.left,", ").concat(this.c.margin.top,")")).attr("class","chart");var t=this.getHeaderHeight();return this.waterfall.select(".header").style("height",t),this.header=this.header.append("svg").append("g").attr("transform","translate(".concat(this.c.margin.left,", ").concat(t,")")).attr("class","header")}getWidth(){return parseInt(this.container.style("width").replace("px",""),10)}setWidth(){if(this.c.minColumnWidth>0){var t=(this.$window.innerWidth-this.c.margin.right-this.c.margin.left)/this.builders.length,e=this.c.minColumnWidth<=t?"100%":"".concat(this.builders.length*this.c.minColumnWidth+this.c.margin.right+this.c.margin.left,"px");return this.waterfall.select(".inner-content").style("width",e),this.waterfall.select(".header-content").style("width",e)}return this.$log.error("Bad column width configuration\n\t min: ".concat(this.c.minColumnWidth))}getHeight(){return parseInt(this.container.style("height").replace("px",""),10)}setHeight(){for(var t=-this.c.gap,e=0,a=Array.from(this.groups);e<a.length;e++){var r=a[e];t+=r.max-r.min+this.c.gap}var i=t*this.c.scaling+this.c.margin.top+this.c.margin.bottom;return i<parseInt(this.waterfall.style("height").replace("px",""),10)&&this.loadMore(),this.container.style("height","".concat(i,"px")),i=this.getHeaderHeight(),this.waterfall.select("div.header").style("height",i+"px"),this.header.attr("transform","translate(".concat(this.c.margin.left,", ").concat(i,")"))}getInnerWidth(){return this.getWidth()-this.c.margin.left-this.c.margin.right}getInnerHeight(){return this.getHeight()-this.c.margin.top-this.c.margin.bottom}getHeaderHeight(){for(var t=0,e=0,a=Array.from(this.builders);e<a.length;e++){var r=a[e];t=Math.max(r.name.length,t)}return Math.max(100,3*t)}getResultClassFromThing(t){var e;if(!t.complete&&t.started_at>=0)e="pending";else switch(t.results){case 0:e="success";break;case 1:e="warnings";break;case 2:e="failure";break;case 3:e="skipped";break;case 4:e="exception";break;case 5:e="cancelled";break;default:e="unknown"}return e}drawXAxis(){var e=this.scale.getX(this.builders,this.getInnerWidth()),a=this.scale.getBuilderName(this.builders);this.header.select(".axis.x").remove();var r=this.header.append("g").attr("class","axis x");r.selectAll("*").remove();var i=this.d3.svg.axis().scale(e).orient("top").tickFormat(a),s=r.call(i);return s.selectAll("text").style("text-anchor","start").attr("transform","translate(0, -16) rotate(-25)").attr("dy","0.75em").each(function(e){return t.d3.select(this.parentNode).append("a").attr("xlink:href","#/builders/".concat(e)).node().appendChild(this)}),s.selectAll("line").data(this.builders).attr("transform","rotate(90)").attr("x1",0).attr("x2",0).attr("y1",e.rangeBand(1)/2).attr("y2",-e.rangeBand(1)/2).attr("class",t.getResultClassFromThing).classed("stroke",!0)}addTicks(t){var e=this.scale.getY(this.groups,this.c.gap,this.getInnerHeight());return this.ticks=this.ticks.concat([e.getCoord(t.complete_at),e.getCoord(t.started_at)])}removeTicks(){return this.ticks=[]}drawYAxis(){var e=this.d3.scale.linear(),a=this.scale.getY(this.groups,this.c.gap,this.getInnerHeight());this.chart.select(".axis.y").remove();var r=this.chart.append("g").attr("class","axis y");r.attr("transform","translate(".concat(this.waterfall.node().scrollLeft,", 0)")),this.waterfall.on("scroll",function(){return o.attr("transform","translate(".concat(this.scrollLeft,", 0)"))}),r.append("rect").attr("x",-this.c.margin.left).attr("y",-this.c.margin.top).attr("width",this.c.margin.left).attr("height",this.getHeight()).style("fill","#fff");for(var i=this.ticks,s=0,l=Array.from(this.groups);s<l.length;s++){var n=l[s];i=i.concat([a.getCoord(n.min),a.getCoord(n.max)])}var o=this.d3.svg.axis().scale(e).orient("left").tickValues(i).tickFormat(t=>{var e=a.invert(t),r=new Date(1e3*e);return this.d3.time.format(this.c.timeFormat)(r)});(o=r.call(o)).selectAll("text").each(function(){var a=t.d3.select(this),r=a.text().split("^");for(a.text(""),e=0;e<r.length;e++){var i=r[e],s=a.append("tspan").text(i);if(0!==e){var l=a.attr("x");s.attr("x",l).attr("dy",10*e)}}});return o.selectAll(".tick").append("line").attr("x2",this.getInnerWidth()).attr("stroke-dasharray",t=>Array.from(this.ticks).includes(t)?"2, 5":"2, 1")}drawBuilds(){var e=this.scale.getX(this.builders,this.getInnerWidth()),a=this.scale.getY(this.groups,this.c.gap,this.getInnerHeight());this.chart.selectAll(".builder").remove();var r=this.chart.selectAll(".builder").data(this.builders).enter().append("g").attr("class","builder").attr("transform",t=>"translate(".concat(e(t.builderid),", 0)")).selectAll(".build").data(t=>t.builds,t=>t.buildid).enter().append("g").attr("class","build").attr("transform",t=>"translate(0, ".concat(a.getCoord(t.complete_at),")"));return r.append("rect").attr("class",t.getResultClassFromThing).attr("width",e.rangeBand(1)).attr("height",t=>(function(t,e){return t>e?t:e})(10,Math.abs(a.getCoord(t.started_at)-a.getCoord(t.complete_at)))).classed("fill",!0),this.c.buildidBackground&&r.append("rect").attr("y",-15).attr("width",e.rangeBand(1)).attr("height",15).style("fill","#ccc"),r.append("text").attr("class","id").attr("x",e.rangeBand(1)/2).attr("y",-3).text(t=>t.number),r.on("mouseover",this.mouseOver).on("mousemove",this.mouseMove).on("mouseout",this.mouseOut).on("click",this.click)}mouseOver(e){var a=t.d3.select(this),r=t.d3.mouse(this);t.addTicks(e),t.drawYAxis();var i=t.d3.select(this.parentNode);this.parentNode.appendChild(this),i.each(function(){return this.parentNode.appendChild(this)});var s=e.builderid<t.builders.length/2,l=40,n=function(){return s?"20,0 0,".concat(l/2," 20,").concat(l," 170,").concat(l," 170,0"):"150,0 170,".concat(l/2," 150,").concat(l," 0,").concat(l," 0,0")},o=a.append("g").attr("class","svg-tooltip").attr("transform","translate(".concat(r[0],", ").concat(r[1],")")).append("g").attr("class","tooltip-content").attr("transform","translate(".concat(s?5:-175,", ").concat(-l/2,")"));return o.append("polygon").attr("points",n()),e.loadSteps().onChange=function(e){l=15*e.length+7,o.transition().duration(100).attr("transform","translate(".concat(s?5:-175,", ").concat(-l/2,")")).select("polygon").attr("points",n());return o.selectAll(".buildstep").data(e).enter().append("g").attr("class","buildstep").append("text").attr("y",(t,e)=>15*(e+1)).attr("x",s?30:10).attr("class",t.getResultClassFromThing).classed("fill",!0).transition().delay(100).text((t,e)=>"".concat(e+1,". ").concat(t.name," ").concat(function(t){var e=new Date(1e3*(t.complete_at-t.started_at));return e>0?"(".concat(e/1e3,"s)"):""}(t)))}}mouseMove(e){var a=t.d3.select(this),r=t.d3.mouse(this);return a.select(".svg-tooltip").attr("transform","translate(".concat(r[0],", ").concat(r[1],")"))}mouseOut(e){var a=t.d3.select(this);return t.removeTicks(),t.drawYAxis(),a.selectAll(".svg-tooltip").remove()}click(e){return t.$uibModal.open({templateUrl:"waterfall_view/views/modal.html",controller:"waterfallModalController as modal",windowClass:"modal-small",resolve:{selectedBuild:()=>e}})}renderNewData(){return this.groups=this.dataProcessorService.getGroups(this.all_builders,this.builds,this.c.threshold),this.$scope.builders=this.builders=this.dataProcessorService.filterBuilders(this.all_builders),this.dataProcessorService.addStatus(this.builders),this.render(),this.loadingMore=!1}render(){var t=this.container.node().parentNode;this.scale.getY(this.groups,this.c.gap,this.getInnerHeight()).invert(t.scrollTop);return this.setWidth(),this.setHeight(),this.drawBuilds(),this.drawXAxis(),this.drawYAxis()}},Cls.initClass(),Cls}();angular.module("waterfall_view",new WaterfallView).controller("waterfallController",["$rootElement","$scope","$q","$timeout","$window","$log","$uibModal","dataService","d3Service","dataProcessorService","scaleService","bbSettingsService","glTopbarContextualActionsService",WaterfallController]);class Waterfall{constructor(t){t.addSettingsGroup({name:"Waterfall",caption:"Waterfall related settings",items:[{type:"integer",name:"scaling_waterfall",caption:"Scaling factor",default_value:1},{type:"integer",name:"min_column_width_waterfall",caption:"Minimum column width (px)",default_value:40},{type:"integer",name:"lazy_limit_waterfall",caption:"Lazy loading limit",default_value:40},{type:"integer",name:"idle_threshold_waterfall",caption:"Idle time threshold in unix time stamp (eg. 300 = 5 min)",default_value:300},{type:"bool",name:"number_background_waterfall",caption:"Build number background",default_value:!1}]})}}angular.module("waterfall_view").config(["bbSettingsServiceProvider",Waterfall]);class WaterfallState{constructor(t,e){var a="waterfall";e.addGroup({name:a,caption:"Waterfall View",icon:"bar-chart-o",order:5});var r={group:a,caption:"Waterfall View"},i={controller:"".concat(a,"Controller"),controllerAs:"w",templateUrl:"waterfall_view/views/".concat(a,".html"),name:a,url:"/".concat(a),data:r};t.state(i)}}angular.module("waterfall_view").config(["$stateProvider","glMenuServiceProvider",WaterfallState]);class DataProcessor{constructor(){}getGroups(t,e,a){var r;e.sort((t,e)=>t.buildid-e.buildid);for(var i=[],s=-1,l={groupid:0,time:0},n=0,o=Array.from(t);n<o.length;n++)(r=o[n]).builds=[];for(var c=0,d=Array.from(e);c<d.length;c++){var h=d[c];null!=(r=t.get(h.builderid))&&r.builds&&(h.started_at-l.time>a&&++s,null==i[s]&&(i[s]={min:h.started_at}),l.groupid!==s&&(i[l.groupid].max=l.time),h.complete||(h.complete_at=Math.round(new Date/1e3)),h.groupid=l.groupid=s,(r=t.get(h.builderid)).builds.push(h),h.complete_at>l.time&&(l.time=h.complete_at))}return i[l.groupid]&&(i[l.groupid].max=l.time),i}addStatus(t){for(var e=0,a=Array.from(t);e<a.length;e++){for(var r=a[e],i=null,s=0,l=Array.from(r.builds);s<l.length;s++){var n=l[s];i=n,n.number>i.number&&(i=n)}r.started_at=null!=i?i.started_at:void 0,r.complete=(null!=i?i.complete:void 0)||!1,r.results=null!=i?i.results:void 0}}filterBuilders(t){for(var e=[],a=0,r=Array.from(t);a<r.length;a++){var i=r[a];(null!=i.builds?i.builds.length:void 0)&&e.push(i)}return e}}angular.module("waterfall_view").service("dataProcessorService",[DataProcessor]);class ScaleService{constructor(){return class{constructor(t){this.d3=t}getX(t,e){return t.map(t=>t.builderid),this.d3.scale.ordinal().domain(t.map(t=>t.builderid)).rangeRoundBands([0,e],.05)}getY(t,e,a){for(var r,i=a,s=i-(t.length-1)*e,l=0,n=0,o=Array.from(t);n<o.length;n++)r=o[n],l+=r.max-r.min;return new class{getCoord(a){for(var n=[],o=0;o<t.length;o++){if((r=t[o]).min<=a&&a<=r.max){n.push(a-r.min);for(var c=0,d=0,h=Array.from(n);d<h.length;d++)c+=h[d];return i-s/l*c-o*e}n.push(r.max-r.min)}}invert(a){for(var n=[],o=0;o<t.length;o++){r=t[o];for(var c=0,d=0,h=Array.from(n);d<h.length;d++)c+=h[d];var u=l/s*(i-a-o*e)-c+r.min;if(r.min<=u&&u<=r.max)return u;n.push(r.max-r.min)}}}}getBuilderName(t){return this.d3.scale.ordinal().domain(t.map(t=>t.builderid)).range(t.map(t=>t.name))}}}}angular.module("waterfall_view").factory("scaleService",[ScaleService]);class WaterfallModal{constructor(t,e,a){this.$uibModalInstance=e,this.selectedBuild=a,t.$on("$stateChangeStart",()=>this.close())}close(){return this.$uibModalInstance.close()}}angular.module("waterfall_view").controller("waterfallModalController",["$scope","$uibModalInstance","selectedBuild",WaterfallModal]),angular.module("waterfall_view").run(["$templateCache",function(t){t.put("waterfall_view/views/waterfall.html",'<div class="waterfall"><div class="load-indicator" ng-show="w.loading"><div class="spinner"><i class="fa fa-circle-o-notch fa-spin fa-2x"></i><p>loading</p></div></div><div class="header"><div class="header-content"></div></div><div class="content"><div class="inner-content"><div class="svg-container"></div></div></div></div>'),t.put("waterfall_view/views/modal.html",'\x3c!-- Show build summary for the selected build in a modal window--\x3e<div class="modal-header"><i class="fa fa-times pull-right" ng-click="modal.close()"></i><h4 class="modal-title">Build summary</h4></div><div class="modal-body"><buildsummary ng-if="modal.selectedBuild" buildid="modal.selectedBuild.buildid"></buildsummary></div>')}]);