---

doc:
  short_help: Make sure a file or folder is synced between two locations.
  help: |
    Make sure a file or folder is synced between two locations.

    This does also create the remote owner/group if necessary.

    For this frecklet, the “local host” is the host the synchronize task originates on, and the “destination host” is the host synchronize is connecting to.
  examples:
    - title: "Rsync a folder recursively."
      desc: |
        Ensure folder ``/tmp/source`` is synced to ``/tmp/dest``. Delete files on ``/tmp/dest`` if they don't exist in the source folder.
      vars:
        src: /tmp/source
        dest: /tmp/dest
        delete_on_dest: true

args:
  src:
    doc:
      short_help: the host and path of the source
      help: |
        Path on the source host that will be synchronized to the destination.

        Examples:
          - /tmp/freckles/src
          - rsync://dev.frkl.io/tmp/freckles/src

    type: string
    empty: false
    required: true
    cli:
      metavar: PATH
  dest:
    doc:
      short_help: the host and path of the target
      help: |
        Path on the target host that will be synchronized to the destination.

        Examples:
          - /tmp/freckles/dest
          - rsync://dev.frkl.io/tmp/freckles/dest
    type: string
    empty: false
    required: true
    cli:
      metavar: PATH
  owner:
    doc:
      short_help: the owner of the dest folder/file
    type: string
    required: false
    cli:
      metavar: USER
  group:
    doc:
      short_help: the group of the dest folder/file
    type: string
    required: false
    cli:
      metavar: GROUP
  become:
    doc:
      short_help: whether to use root permissions to do the download/chown of target
    type: boolean
    required: false
    default: false
    cli:
      is_flag: true
  mode:
    doc:
      short_help: The permissions of the folder.
    type: string
    required: false
    cli:
      metavar: MODE
  delete_on_dest:
    doc:
      short_help: Whether to delete the files on 'dest' that don't exist on the 'src'.
    type: boolean
    required: false
    default: false
    cli:
      metavar: PATH
      show_default: true

meta:
  requirements:
    - rsync installed on both source and target host
  tags:
    - filesystem
    - file
    - sync
    - featured-frecklecutable

frecklets:

  - task:
      become: "{{:: become ::}}"
    frecklet:
      name: synchronize
      type: ansible-module
      idempotent: true
      elevated: "{{:: become ::}}"
      msg: "synchronize '{{:: src ::}}' -> '{{:: dest ::}}'"
      desc: |
        Synchronize path '{{:: src ::}}' to '{{:: dest ::}}' (recursively if the source is a folder).

        {%:: if delete_on_dest ::%}Delete files on '{{:: dest ::}}' that don't exist in the source folder.{%:: endif ::%}
      references:
        "'synchronize' Ansible module": "https://docs.ansible.com/ansible/latest/modules/synchronize_module.html"
    vars:
      src: "{{:: src ::}}"
      dest: "{{:: dest ::}}"
      delete: "{{:: delete_on_dest ::}}"
      recursive: true

  - path-attributes:
      frecklet::skip: "{{:: owner | true_if_all_empty(group, mode) ::}}"
      path: "{{:: dest ::}}"
      owner: "{{:: owner ::}}"
      group: "{{:: group ::}}"
      mode: "{{:: mode ::}}"
