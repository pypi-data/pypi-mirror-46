- name: Install
  hosts: '*'
  become: yes
  become_user: root
  vars:
    is_debug_mode: true
    root_home: '{{ ansible_env.HOME }}'  # because lookup('env', 'HOME') gets envvar before sudo (from controller)

    # Main
    # We do not care about `server_base_url` in configuration file, PACKY_SERVER_BASE_URL env var overrides here on purpose
    server_base_url: "{{ lookup('env', 'PACKY_SERVER_BASE_URL') | default('https://dashboard.packy.io', true) }}"
    settings_filename: "{{ lookup('env', 'PACKY_AGENT_SETTINGS_FILENAME') | default('/etc/packy-agent-settings.yaml', true) }}"

    # Virtualenv related
    venvs_dir: "{{ lookup('env', 'VENVS_DIR') | default(root_home + '/.virtualenvs', true) }}"

    venv: "{{ lookup('env', 'PACKY_VENV') | default('packy-agent', true) }}"
    temp_venv: "{{ lookup('env', 'PACKY_TEMP_VENV') | default('packy-agent-temp', true) }}"
    bak_venv: '{{ venv }}-bak'

    venv_dir: '{{ venvs_dir }}/{{ venv }}'
    temp_venv_dir: "{{ lookup('env', 'PACKY_TEMP_VENV_DIR') | default(venvs_dir + '/' + temp_venv, true) }}"
    bak_venv_dir: '{{ venvs_dir }}/{{ bak_venv }}'

    venv_bin_dir: '{{ venv_dir }}/bin'

    # Paths
    agent_data_directory: /var/lib/packy-agent
    recover_script_path: '{{ root_home }}/packy-recover.sh'
    expected_version_file_path: /etc/packy-expected-version

    # Misc
    virtualenvwrapper_python: "{{ lookup('env', 'VIRTUALENVWRAPPER_PYTHON') | default('/usr/bin/python', true) }}"
    packy_agent_package_name: "{{ lookup('env', 'PACKY_AGENT_PACKAGE_NAME') | default('packy-agent', true) }}"
    pip_extra_args: "{{ lookup('env', 'PIP_EXTRA_ARGS') }}"
    is_development: false
    is_inside_docker_container: false
    remove_nginx_default_landing: "{{ (lookup('env', 'PACKY_REMOVE_NGINX_DEFAULT_LANDING') | default('False', true)) == 'True' }}"  # used for Orange Pi installation
    restart: "{{ (lookup('env', 'PACKY_RESTART') | default('True', true)) == 'True' }}"  # used for Docker build
  tasks:
    - name: Asserting running as root...
      assert:
        that: "ansible_user_id == 'root'"
    - name: Gathering custom facts...
      include_tasks: misc/gather-facts.yaml
    - name: Installing/upgrading/configuring common dependencies...
      include_tasks: components/common/base.yaml
    - name: Installing/upgrading/configuring Worker...
      include_tasks: components/worker/base.yaml
    - name: Installing/upgrading/configuring Console...
      include_tasks: components/console/base.yaml
    - name: Installing/upgrading/configuring Wathchdog...
      include_tasks: components/watchdog/base.yaml
    - name: Installing/upgrading/configuring common dependencies (post)...
      include_tasks: components/common-post.yaml
    - name: Preparing installation recovery...
      include_tasks: misc/recovery.yaml
    - name: Replacing virtualenv...
      vars:
# Rename virtualenv directory (keeps running services operating). Then try to copy temp
# virtualenv to the original. If it succeeds then remove old and temp virtualenv else rename
# it back.
        command: '(echo "Moving {{ venv_dir }} to {{ bak_venv_dir }}..." && mv {{ venv_dir }} {{ bak_venv_dir }} && echo "Moved {{ venv_dir }} to {{ bak_venv_dir }}";
                  (echo "Copying {{ temp_venv }} to {{ venv }}..." && cpvirtualenv {{ temp_venv }} {{ venv }} && echo "Copied {{ temp_venv }} to {{ venv }}" &&
                   (echo "Removing {{ bak_venv }}..." && rmvirtualenv {{ bak_venv }} && echo "Removed {{ bak_venv }}"; rm -rf {{ bak_venv_dir }} && echo "Removed {{ bak_venv_dir }}" || true)) ||
                   (echo "Restoring from {{ bak_venv_dir }}..." && mv {{ bak_venv_dir }} {{ venv_dir }} && echo "Moved {{ bak_venv_dir }} to {{ venv_dir }}" && false))'
      include_tasks: misc/virtualenvwrapper.yaml
    - name: Restarting...
      include_tasks: misc/restart.yaml
