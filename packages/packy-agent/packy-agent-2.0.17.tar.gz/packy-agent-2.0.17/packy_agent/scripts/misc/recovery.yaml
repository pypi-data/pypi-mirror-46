- name: Removing previously successful installation markers...
  file:
    path: '{{ item }}'
    state: absent
  with_items:
    - /etc/packy-agent-worker-version
    - /etc/packy-agent-console-version
    - /etc/packy-agent-watchdog-version
- name: Creating installation recovery marker...
  shell: "source {{ temp_venv_dir }}/bin/activate && (python -c 'import packy_agent; print(f\"PACKY_EXPECTED_VERSION={packy_agent.__version__}\")' > {{ expected_version_file_path }}); deactivate"
  args:
    executable: /bin/bash
- name: Creating recover script...
  template:
    src: packy-recover.sh.j2
    dest: '{{ recover_script_path }}'
    mode: u+x
- name: Installing recover script for cron reboot...
  cron:
    name: Packy recover script
    job: 'SHELL=/bin/bash {{ recover_script_path }} >> /var/log/packy-recover.log 2>&1'
    special_time: reboot
    backup: yes
  when: not is_inside_docker_container
