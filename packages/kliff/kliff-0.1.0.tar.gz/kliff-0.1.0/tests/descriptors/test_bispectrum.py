import numpy as np
from kliff.dataset import Configuration
from kliff.descriptors import Bispectrum

zeta_ref = [[9.67233961e+00,  7.11696281e+00,  3.64267853e+00,  9.67186730e+00,
             5.16158022e+00,  1.87921544e+00,  6.30815842e+00,  8.92398717e+00,
             4.20835447e+00,  2.21451314e+00,  2.50615741e+00,  1.33881116e+01,
             4.60013516e+00,  5.06161573e+00],
            [4.12842991e+01,  9.07588360e+00,  1.53655662e+00,  6.20291097e+00,
             1.87679232e+00,  1.07391872e+00,  1.98717119e+00,  3.29696884e+01,
             7.70422907e+00, -3.31491113e-02,  1.03289442e+01,  4.90925660e+01,
             2.82436942e+00,  1.24081835e+01],
            [1.73741554e+01,  5.52458737e+00,  1.96946128e-01,  1.04292104e+01,
             3.55805716e+00,  1.18314825e+00,  3.91265100e+00,  1.58723840e+01,
             4.48329643e+00,  2.81638023e+00,  5.91001876e+00,  2.22956933e+01,
             6.61593854e+00,  8.78960892e+00],
            [7.54202120e+00,  3.88998085e+00,  1.84728448e+00,  7.92505231e+00,
             3.17562384e+00,  2.57786432e+00,  5.79129219e+00,  8.38915899e+00,
             4.19169728e+00,  2.52893629e+00,  4.54391666e+00,  1.59250759e+01,
             7.75529446e+00,  8.71117842e+00],
            [1.81428646e+01,  5.58779679e+00,  2.42492943e-01,  1.06442756e+01,
             3.60183088e+00,  5.19421191e-01,  4.45926283e+00,  1.55305607e+01,
             4.06832692e+00,  2.64394591e+00,  5.65285302e+00,  2.25947275e+01,
             6.72632618e+00,  8.82676665e+00],
            [7.20942183e+00,  3.35387725e+00,  1.29834905e+00,  7.40333237e+00,
             3.04806432e+00,  2.62397206e+00,  5.47358955e+00,  8.82578443e+00,
             4.07363243e+00,  3.14645616e+00,  5.32317864e+00,  1.48942847e+01,
             7.29826349e+00,  8.05789635e+00],
            [1.55876864e+01,  4.96629002e+00,  7.20501227e-02,  9.24460991e+00,
             3.26832361e+00,  1.05017170e+00,  4.04959834e+00,  1.59503590e+01,
             4.56659280e+00,  3.47242538e+00,  7.21475752e+00,  2.12985011e+01,
             6.19157000e+00,  9.13757773e+00],
            [6.98474121e+00,  3.25489619e+00,  1.38505477e+00,  7.53831385e+00,
             2.97284093e+00,  2.72033762e+00,  5.87839298e+00,  8.39930075e+00,
             4.03605570e+00,  3.02566585e+00,  5.18825294e+00,  1.53404945e+01,
             7.81374089e+00,  8.65233779e+00]]

dzeta_dr_001 = [[[-6.39268316e+00, -6.86589539e+00, -6.62024394e+00],
                 [2.16503211e+00,  2.36645084e+00,  2.38444841e+00],
                 [-3.21580741e-02,  2.11132242e+00,  1.95472362e+00],
                 [0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
                 [2.23695231e+00,  1.20777528e-01,  2.34747873e+00],
                 [0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
                 [2.02285681e+00,  2.26734460e+00, -6.64068138e-02],
                 [0.00000000e+00,  0.00000000e+00,  0.00000000e+00]],
                [[-5.22011564e+00, -5.33684406e+00, -5.49690457e+00],
                 [3.14644477e+00,  3.51638646e+00,  3.53197204e+00],
                 [-1.12782961e-01,  8.68000925e-01,  7.94524758e-01],
                 [0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
                 [1.26962538e+00, -8.51094111e-02,  1.33159255e+00],
                 [0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
                 [9.16828446e-01,  1.03756608e+00, -1.61184779e-01],
                 [0.00000000e+00,  0.00000000e+00,  0.00000000e+00]]]

dzeta_dr_minus_121 = [[[0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
                       [3.12475437e-01,  3.24356814e-01, -6.68023945e-02],
                       [-8.63269237e-01, -2.76358711e-01,  2.44682793e-01],
                       [6.96102118e-01,  7.11951913e-02, -6.90939013e-01],
                       [-3.35455831e-01, -8.98079831e-01,  2.69389345e-01],
                       [6.06252875e-02,  1.32942947e+00, -1.31600607e+00],
                       [-8.74938767e-01, -7.52900651e-01, -7.02958799e-01],
                       [1.00446099e+00,  2.02357721e-01,  2.26263414e+00]],
                      [[0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
                       [5.55828779e-01,  5.59311995e-01,  2.84957153e-02],
                       [-5.05085367e-01, -1.54057451e-01,  1.50878576e-01],
                       [1.51893023e+00,  7.81720721e-02, -1.52518695e+00],
                       [-1.96182375e-01, -5.48614995e-01,  1.71857203e-01],
                       [2.70303840e-02,  1.74694325e+00, -1.75640560e+00],
                       [-1.78858747e+00, -1.53682143e+00, -1.72681136e+00],
                       [3.88065824e-01, -1.44933440e-01,  4.65717241e+00]]]


def test_desc():

    fname = '../configs_extxyz/Si.xyz'
    conf = Configuration(format='extxyz')
    conf.read(fname)

    cut_name = 'cos'
    cut_dists = {'Si-Si': 5.0}
    hyperparams = {'jmax': 2,
                   'rfac0': 1,
                   'diagonalstyle': 3,
                   'rmin0': 0,
                   'switch_flag': 1,
                   'bzero_flag': 0,
                   'weight': {'Si': 1.}}

    desc = Bispectrum(cut_dists, cut_name, hyperparams)
    zeta, dzeta_dr = desc.transform(conf, grad=True)
    assert desc.get_size() == 14
    assert np.allclose(zeta, zeta_ref)
    assert np.allclose(dzeta_dr[0][:2], dzeta_dr_001)
    assert np.allclose(dzeta_dr[-1][-2:], dzeta_dr_minus_121)

    zeta, dzeta_dr = desc.transform(conf, grad=False)
    assert np.allclose(zeta, zeta_ref)
    assert dzeta_dr is None


if __name__ == '__main__':
    test_desc()
